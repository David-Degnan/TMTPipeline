---
title: "TMT Pipeline Package Benchmark"
output: html_document
date: "2022-10-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(TMTPipeline)
library(pmartR)
library(MSnID)
library(DT)
library(data.table)
library(dplyr)
```

## Summary

The goal of this markdown is to show Lisa and Paul the results for the pipeline 
to process MASIC (abundances) and MS-GF+ (peptide/protein identification) data to pmartR
data objects, and help them make educated choices regarding each step. 

The pipeline is relatively simple: 

0. Pull MS-GF+ and MASIC results from DMS. This is done externally to this package with PNNL.DMS.UTIL. It will eventually be replaced. 

1. Filter MS-GF+ data
    a. Filter to a FDR > 0.01 and MS1 PPM error > 10. We use the MSnID package.
    b. Then remove decoys 
    
2. Filter MASIC Data 
    a. Filter out interference scores of less than 0.5 
    
3. Combine and generate pmartR objects 

Note that in step 1, it is essential that decoys are filtered after the FDR 
filtering step.

## Data Package 4234

The msnid data object: 

```{r}
# Load files
msnid <- readRDS("~/Desktop/OldProjects/TMT/4234_Tafesse/4234_Data_Package.RDS")$msnid
datatable(msnid %>% psms() %>% head(5), options = list(scrollX = T))
```

The masic file: 

```{r}
masic <- readRDS("~/Desktop/OldProjects/TMT/4234_Tafesse/4234_Data_Package.RDS")$masic
datatable(masic %>% head(5), options = list(scrollX = T))
```

The percentage of missingness in the masic file is: 

```{r}
sum(masic[,3:18] == 0 | is.na(masic[,3:18])) / (nrow(masic) * 16) * 100
```

Load the metadata file. PlexNames and IonChannelNames should match the masic data. 
Sample names is what will end up in the f_data and e_data files. 

```{r}
metadata <- read.csv("~/Desktop/OldProjects/TMT/Results/DataPackage4234/metadata.csv")
datatable(metadata, options = list(scrollX = T))
```

Run the pipeline: 

```{r}
tmt_pipeline(msnid, masic, metadata, "~/Desktop/OldProjects/TMT/Results/DataPackage4234/")

# Add X to f_data names so that the data easily loads into pmartR
f_data <- read.csv("~/Desktop/OldProjects/TMT/Results/DataPackage4234/f_data.csv")
f_data$SampleNames <- paste0("X", f_data$SampleNames)
write.csv(f_data, "~/Desktop/OldProjects/TMT/Results/DataPackage4234/f_data.csv", quote = F, row.names = F)
```

Generate a pmartR object. Note the 76% missingness after FDR, decoy, and interference filtering. 

```{r}
e_data <- read.csv("~/Desktop/OldProjects/TMT/Results/DataPackage4234/e_data.csv")
e_meta <- read.csv("~/Desktop/OldProjects/TMT/Results/DataPackage4234/e_meta.csv")
isoPep <- as.isobaricpepData(e_data, f_data, e_meta, "Peptide", "SampleNames", "Protein")
summary(isoPep)
```

Now log2 transform, run isobaric normalization, and protein quantification. There 
is no pmartR filtering with this check, which is why contaminants show up in this table. 

```{r}
isoPep <- edata_transform(isoPep, "log2")
isoNorm <- normalize_isobaric(isoPep, apply_norm = T, exp_cname = "PlexNames", 
                              refpool_cname = "Type", refpool_notation = "Reference")
isoRoll <- protein_quant(isoPep, method = "rollup")
datatable(isoRoll$e_data, options = list(scrollX = T))
```


## Data Package 4005

#### Original Results

Using the first pipeline, here are the rollup results using the same set up laid out before: 

```{r}
Ori_4005_e_data <- fread("~/Desktop/OldProjects/TMT/4005_Tafess_LI/4005_global_pipetide_crosstab.txt")
Ori_4005_e_meta <- Ori_4005_e_data[,c("Peptide", "Protein")]
Ori_4005_f_data <- data.frame(
  SampleNames = colnames(Ori_4005_e_data)[5:15], 
  IonChannelNames = c("Ion_126.128", "Ion_127.125", "Ion_127.131", "Ion_128.128",
                      "Ion_128.134", "Ion_129.131", "Ion_129.138", "Ion_130.135", 
                      "Ion_130.141", "Ion_131.138", "Ion_131.144"),
  PlexNames = "OnlyOne"
)
Ori_4005_e_data <- Ori_4005_e_data[,c(4:15)]

Ori_isoPep_4005 <- as.isobaricpepData(Ori_4005_e_data, Ori_4005_f_data, Ori_4005_e_meta, 
  edata_cname = "Peptide", fdata_cname = "SampleNames", emeta_cname = "Protein")

# Proportion missing is very low 
summary(Ori_isoPep_4005)
```

```{r}
Ori_isoPep_4005 <- edata_transform(Ori_isoPep_4005, "log2")
Ori_isoNorm_4005 <- normalize_isobaric(Ori_isoPep_4005, apply_norm = T, exp_cname = "PlexNames", 
                                   refpool_cname = "SampleNames", refpool_notation = "Reference")
Ori_isoRoll_4005 <- protein_quant(Ori_isoPep_4005, method = "rollup")
datatable(Ori_isoRoll_4005$e_data, options = list(scrollX = T))
```

The number of significant biomolecules is: 


```{r}
Ori_isoRoll_4005$f_data$Group <- c(NA, rep("Mock", 5), rep("Disease", 5))
Ori_isoRoll_4005 <- group_designation(Ori_isoRoll_4005, main_effects = "Group")
Ori_isoRoll_4005 <- applyFilt(imdanova_filter(Ori_isoRoll_4005), min_nonmiss_anova = 2, min_nonmiss_gtest = 3, 
                              Ori_isoRoll_4005)
Ori_isoStat_4005 <- imd_anova(Ori_isoRoll_4005, test_method = "anova")
sum(Ori_isoStat_4005$Flag_A_Mock_vs_Disease != 0)
```


#### New Pipeline 

The missingness in the 4005 masic file is: 

```{r}
# Load files
msnid_4005 <- readRDS("~/Desktop/OldProjects/TMT/4005_Tafess_LI/4005_Data_Package.RDS")$msnid
masic_4005 <- readRDS("~/Desktop/OldProjects/TMT/4005_Tafess_LI/4005_Data_Package.RDS")$masic

sum(masic_4005[,3:13] == 0 | is.na(masic_4005[,3:13])) / (nrow(masic_4005) * 11) * 100
```

```{r}
# Masic has different names for the same plex, which is not helpful 
class(masic_4005) <- c(class(masic_4005), "masic_data")
metadata_4005 = data.frame(
  "PlexNames" = unique(masic_4005$Dataset),
  "IonChannelNames" = c(colnames(masic_4005)[3:13], NA),
  "SampleNames" = c("Taffesse_LI_Mock_1",
                    "Taffesse_LI_SarsCov2_1",
                    "Taffesse_LI_Mock_2",
                    "Taffesse_LI_Mock_3",
                    "Taffesse_LI_SarsCov2_2",
                    "Taffesse_LI_SarsCov2_3",
                    "Taffesse_LI_Mock_4",
                    "Taffesse_LI_SarsCov2_4",
                    "Taffesse_LI_SarsCov2_5",
                    "Taffesse_LI_Mock_5",
                    "Reference",
                    "")
)
tmt_pipeline(msnid_4005, masic_4005, metadata_4005, "~/Desktop/OldProjects/TMT/Results/DataPackage4005/")
```

```{r}
e_data_4005 <- read.csv("~/Desktop/OldProjects/TMT/Results/DataPackage4005/e_data.csv")
e_meta_4005 <- read.csv("~/Desktop/OldProjects/TMT/Results/DataPackage4005/e_meta.csv")
f_data_4005 <- read.csv("~/Desktop/OldProjects/TMT/Results/DataPackage4005/f_data.csv")
isoPep_4005 <- as.isobaricpepData(e_data_4005, f_data_4005, e_meta_4005, 
  edata_cname = "Peptide", fdata_cname = "SampleNames", emeta_cname = "Protein")
summary(isoPep_4005)
```

```{r}
isoPep_4005 <- edata_transform(isoPep_4005, "log2")
isoPep_4005$f_data$PlexNames <- "Plex1"
isoNorm_4005 <- normalize_isobaric(isoPep_4005, apply_norm = T, exp_cname = "PlexNames", 
                                   refpool_cname = "SampleNames", refpool_notation = "Reference")
isoRoll_4005 <- protein_quant(isoPep_4005, method = "rollup")
datatable(isoRoll_4005$e_data, options = list(scrollX = T))
```

```{r}
isoRoll_4005$f_data$Group <- c("Mock", "Disease", "Mock", "Mock", "Disease", "Disease",
                               "Mock", "Disease", "Disease", "Mock", NA)
isoRoll_4005 <- group_designation(isoRoll_4005, main_effects = "Group")
isoRoll_4005 <- applyFilt(imdanova_filter(isoRoll_4005), min_nonmiss_anova = 2, min_nonmiss_gtest = 3, 
                              isoRoll_4005)
isoStat_4005 <- imd_anova(isoRoll_4005, test_method = "anova")
sum(isoStat_4005$Flag_A_Mock_vs_Disease != 0)
```
